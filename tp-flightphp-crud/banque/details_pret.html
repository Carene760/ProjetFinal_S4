<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Détails du Prêt</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    .info-card {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 5px;
      border-left: 4px solid #3498db;
    }
    .info-card h3 {
      margin-top: 0;
      color: #3498db;
    }
    .info-card p {
      margin: 5px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #3498db;
      color: white;
    }
    tr:hover {
      background-color: #f5f5f5;
    }
    .statut-en-cours {
      color: #f39c12;
      font-weight: bold;
    }
    .statut-rembourse {
      color: #27ae60;
      font-weight: bold;
    }
    .statut-impaye {
      color: #e74c3c;
      font-weight: bold;
    }
    .btn-retour {
      display: inline-block;
      padding: 10px 15px;
      background-color: #3498db;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .btn-retour:hover {
      background-color: #2980b9;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="Pret.html" class="btn-retour">← Retour à la liste</a>
    <h1>Détails du Prêt #<span id="pret-id"></span></h1>
    
    <div class="info-grid">
      <div class="info-card">
        <h3>Informations Client</h3>
        <p><strong>Nom:</strong> <span id="client-nom"></span></p>
        <p><strong>ID Client:</strong> <span id="client-id"></span></p>
      </div>
      
      <div class="info-card">
        <h3>Informations Prêt</h3>
        <p><strong>Montant:</strong> <span id="montant"></span> Ar</p>
        <p><strong>Durée:</strong> <span id="duree"></span> mois</p>
        <p><strong>Taux:</strong> <span id="taux"></span>%</p>
      </div>
      
      <div class="info-card">
        <h3>Dates & Statut</h3>
        <p><strong>Date début:</strong> <span id="date-debut"></span></p>
        <p><strong>Date fin:</strong> <span id="date-fin"></span></p>
        <p><strong>Statut:</strong> <span id="statut"></span></p>
      </div>
    </div>

    <div class="info-card">
      <h3>Paiements</h3>
      <p><strong>Annuité:</strong> <span id="annuite"></span> Ar</p>
      <p><strong>Fréquence:</strong> <span id="frequence"></span></p>
      <p><strong>Total à rembourser:</strong> <span id="total-rembourse"></span> Ar</p>
    </div>

    <h2>Tableau d'Amortissement</h2>
    <table id="tableau-amortissement">
      <thead>
        <tr>
          <th>Période</th>
          <th>Date</th>
          <th>Capital restant</th>
          <th>Intérêt</th>
          <th>Capital</th>
          <th>Annuité</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="info-card" id="assurance-section">
      <h3>Assurance</h3>
      <p><strong>Taux assurance:</strong> <span id="taux-assurance"></span>%</p>
      <p><strong>Montant assurance:</strong> <span id="montant-assurance"></span> Ar</p>
    </div>
    
    <div class="info-card" id="delai-section" style="display:none;">
        <h3>Période de Délai</h3>
        <p><strong>Durée:</strong> <span id="delai-duree"></span> mois</p>
        <p><strong>Paiement des intérêts seulement</strong></p>
    </div>
    
    <!-- Bouton de validation -->
    <div style="text-align: center; margin-top: 30px;">
        <button id="btn-valider" class="btn-valider" style="padding: 10px 20px; background-color: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Valider le Prêt
        </button>
        <p id="message-validation" style="margin-top: 10px;"></p>
    </div>
  </div>

  <script>
    const apiBase = "http://localhost/S4/ProjetFinal_S4_/tp-flightphp-crud/ws";
    const pretId = new URLSearchParams(window.location.search).get('id');
    console.log("ID du prêt:", pretId); // Ajoutez ce log
    // Fonction pour formater les nombres
    function formatNumber(num) {
      return new Intl.NumberFormat('fr-FR').format(num);
    }

    // Fonction pour formater les dates
    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      return new Date(dateString).toLocaleDateString('fr-FR', options);
    }

    // Fonction pour calculer le tableau d'amortissement
    function calculerTableauAmortissement(pret) {
      const tableau = [];
      let capitalRestant = parseFloat(pret.montant);
      const tauxPeriodique = parseFloat(pret.taux_interet) / 100 / 12; // Taux mensuel
      const annuite = parseFloat(pret.annuite);
      const dateDebut = new Date(pret.date_debut);
      
      for (let periode = 1; periode <= pret.duree; periode++) {
        const interet = capitalRestant * tauxPeriodique;
        const capital = annuite - interet;
        capitalRestant -= capital;
        
        // Calcul de la date pour chaque période
        const datePaiement = new Date(dateDebut);
        datePaiement.setMonth(dateDebut.getMonth() + periode);
        
        tableau.push({
          periode,
          date: datePaiement.toISOString().split('T')[0],
          capitalRestant: capitalRestant > 0 ? capitalRestant : 0,
          interet,
          capital,
          annuite,
          statut: periode <= pret.paiements_effectues ? 'Payé' : 'À payer'
        });
      }
      
      return tableau;
    }

    // Fonction pour afficher les détails du prêt
    function afficherDetailsPret(pret) {
      document.getElementById('pret-id').textContent = pret.id_pret;
      document.getElementById('client-nom').textContent = pret.client_nom || 'N/A';
      document.getElementById('client-id').textContent = pret.id_client;
      document.getElementById('montant').textContent = formatNumber(pret.montant);
      document.getElementById('duree').textContent = pret.duree;
      document.getElementById('taux').textContent = pret.taux_interet;
      document.getElementById('date-debut').textContent = formatDate(pret.date_debut);
      document.getElementById('date-fin').textContent = formatDate(pret.date_fin);
      
      // Gestion du statut avec style différent
      const statutElement = document.getElementById('statut');
      statutElement.textContent = pret.statut;
      statutElement.className = `statut-${pret.statut.toLowerCase().replace('é', 'e')}`;
      
      document.getElementById('annuite').textContent = formatNumber(pret.annuite);
      document.getElementById('frequence').textContent = pret.frequence_remboursement;
      document.getElementById('total-rembourse').textContent = formatNumber(pret.annuite * pret.duree);
      
      // Générer et afficher le tableau d'amortissement
      const tableauAmortissement = calculerTableauAmortissement(pret);
      const tbody = document.querySelector('#tableau-amortissement tbody');
      tbody.innerHTML = '';
      
      tableauAmortissement.forEach(paiement => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${paiement.periode}</td>
          <td>${formatDate(paiement.date)}</td>
          <td>${formatNumber(paiement.capitalRestant.toFixed(2))}</td>
          <td>${formatNumber(paiement.interet.toFixed(2))}</td>
          <td>${formatNumber(paiement.capital.toFixed(2))}</td>
          <td>${formatNumber(paiement.annuite.toFixed(2))}</td>
          <td class="${paiement.statut === 'Payé' ? 'statut-rembourse' : 'statut-en-cours'}">${paiement.statut}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('taux-assurance').textContent = pret.taux_assurance || '0';
      document.getElementById('montant-assurance').textContent = formatNumber(pret.assurance || 0);

      // Afficher les infos délai si applicable
      if(pret.delai_mois > 0) {
          document.getElementById('delai-section').style.display = 'block';
          document.getElementById('delai-duree').textContent = pret.delai_mois;
      }

      // Gestion du bouton de validation
      const btnValider = document.getElementById('btn-valider');
      const messageValidation = document.getElementById('message-validation');
      
      if(pret.is_valide) {
          btnValider.disabled = true;
          btnValider.textContent = 'Prêt déjà validé';
          messageValidation.textContent = 'Ce prêt a déjà été validé et est en cours.';
      } else {
          btnValider.onclick = function() {
              if(confirm('Êtes-vous sûr de vouloir valider ce prêt ?')) {
                  validerPret(pret.id_pret);
              }
          };
      }
    }

    function validerPret(idPret) {
      const btnValider = document.getElementById('btn-valider');
      btnValider.disabled = true;
      
      fetch(`${apiBase}/prets/${idPret}/valider`, {
          method: 'POST'
      })
      .then(response => response.json())
      .then(data => {
          if(data.success) {
              document.getElementById('message-validation').textContent = data.message;
              document.getElementById('btn-valider').textContent = 'Prêt validé';
              document.getElementById('statut').textContent = 'validé';
              document.getElementById('statut').className = 'statut-rembourse';
          } else {
              alert('Erreur: ' + data.message);
              btnValider.disabled = false;
          }
      })
      .catch(error => {
          console.error('Erreur:', error);
          alert('Une erreur est survenue');
          btnValider.disabled = false;
      });
  }

    // Charger les données du prêt
    function chargerDetailsPret() {
    console.log("Tentative de chargement du prêt", pretId);
    fetch(`${apiBase}/prets/${pretId}`)
        .then(response => {
            if(!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(pret => {
            console.log("Données reçues:", pret);
            afficherDetailsPret(pret);
        })
        .catch(error => {
            console.error('Erreur complète:', error);
            alert(`Erreur détaillée: ${error.message}`);
        });
}

    // Démarrer le chargement des données
    if (pretId) {
      chargerDetailsPret();
    } else {
      alert('Aucun ID de prêt spécifié');
      window.location.href = 'Pret.html';
    }
  </script>
</body>
</html>